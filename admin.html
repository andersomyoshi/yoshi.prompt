<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yoshi Prompts - Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #8bc6f2, #a18dce); }
        .main-container { max-width: 500px; margin: 0 auto; }
        .btn-main.active { background-color: #22c55e; color: white; transform: scale(1.05); }
        .btn-sub.active, .btn-sub-prompt.active { background-color: #16a34a; color: white; }
        .page-content { background-color: rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); }
        .history-box::-webkit-scrollbar { width: 5px; } .history-box::-webkit-scrollbar-track { background: transparent; } .history-box::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.3); border-radius: 10px; }
    </style>
</head>
<body class="text-gray-800">
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm w-full"><p id="confirm-message" class="mb-4 text-lg"></p><div class="flex justify-center space-x-4"><button id="confirm-yes" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg">Sim</button><button id="confirm-no" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-6 rounded-lg">Não</button></div></div>
    </div>
    <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-6 rounded-lg shadow-xl text-center"><p id="notification-message"></p></div></div>
    <div class="main-container min-h-screen p-4 flex flex-col">
        <header class="flex justify-between items-center mb-4 text-white"><h1 id="admin-name" class="text-3xl font-bold">Admin</h1><button onclick="window.location.href='index.html'" class="text-4xl transform hover:scale-110">&laquo;</button></header>
        <div class="flex justify-around items-center mb-6 space-x-2">
            <button onclick="showPage('cadastrar')" data-page="cadastrar" class="btn-main flex-1 py-2 px-4 bg-lime-300 rounded-full shadow-md hover:bg-lime-400 font-semibold">Cadastrar</button>
            <button onclick="showPage('monitorar')" data-page="monitorar" class="btn-main flex-1 py-2 px-4 bg-lime-300 rounded-full shadow-md hover:bg-lime-400 font-semibold">Monitorar</button>
            <button onclick="showPage('adc-prompts')" data-page="adc-prompts" class="btn-main flex-1 py-2 px-4 bg-lime-300 rounded-full shadow-md hover:bg-lime-400 font-semibold active">Adc. Prompts</button>
        </div>
        <main class="flex-grow">
            <div id="monitorar-page" class="page-content rounded-2xl p-4 hidden">
                <h2 class="text-center font-bold text-white bg-black/20 rounded-full py-2 mb-4">HISTÓRICO GERAL</h2>
                <div id="global-history-log" class="history-box bg-white/80 p-4 rounded-lg h-96 overflow-y-auto text-sm space-y-2"><p>Carregando...</p></div>
                <div class="mt-6 flex flex-wrap justify-center gap-4">
                    <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg" onclick="saveAsPDF()">Salvar em PDF</button>
                    <button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg" onclick="backupData()">Fazer Backup (JSON)</button>
                    <button class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg" onclick="triggerRestore()">Restaurar Backup</button>
                </div>
            </div>
            <div id="cadastrar-page" class="page-content rounded-2xl p-4 hidden"><div class="flex justify-around items-center mb-4 text-xs space-x-2"><button onclick="newUser()" data-userview="novo" class="btn-sub flex-1 py-2 px-2 rounded-full shadow hover:bg-lime-500">NOVO</button><button onclick="showUserView('pesquisar')" data-userview="pesquisar" class="btn-sub flex-1 py-2 px-2 rounded-full shadow hover:bg-gray-500">PESQUISAR</button><button onclick="deleteCurrentUser()" class="btn-sub flex-1 py-2 px-2 bg-red-500 text-white rounded-full shadow hover:bg-red-600">EXCLUIR</button></div><div id="user-form-view"><div class="space-y-3 text-sm"><input id="user-vencimento" type="date" class="w-full p-2 rounded-lg"><div id="user-vencimento-label" class="w-full p-2 rounded-lg bg-cyan-800 text-white text-center"></div><input id="user-id" type="text" placeholder="ID (automático)" class="w-full p-2 rounded-lg" disabled><input id="user-name" type="text" placeholder="Nome" class="w-full p-2 rounded-lg"><input id="user-password" type="text" placeholder="Senha" class="w-full p-2 rounded-lg"><div class="flex space-x-2"><input id="user-login" type="text" placeholder="Login" class="flex-grow p-2 rounded-lg"><button class="bg-green-500 hover:bg-green-600 text-white font-bold p-2 rounded-lg" onclick="saveCurrentUser()">Salvar</button></div></div><div class="mt-4"><h3 class="text-center font-bold text-white bg-black/20 rounded-full py-1 my-2">HISTÓRICO DO USUÁRIO</h3><div id="user-history-log" class="history-box bg-white/80 p-2 rounded-lg h-32 overflow-y-auto text-sm space-y-1"></div></div></div><div id="user-pesquisar-view" class="hidden"><input type="text" id="user-search-input" onkeyup="renderUsers()" placeholder="Pesquisar..." class="w-full p-2 rounded-lg mb-2"><div id="user-list" class="history-box bg-white/80 p-2 rounded-lg h-[25rem] overflow-y-auto text-sm space-y-2"></div></div></div>
            <div id="adc-prompts-page" class="page-content rounded-2xl p-4"><div class="flex justify-around items-center mb-4 text-xs space-x-2"><button onclick="newPrompt()" data-view="novo" class="btn-sub-prompt flex-1 py-2 px-2 rounded-full shadow hover:bg-lime-500">NOVO</button><button onclick="showPromptView('pesquisar')" data-view="pesquisar" class="btn-sub-prompt flex-1 py-2 px-2 rounded-full shadow hover:bg-gray-500">PESQUISAR</button><button onclick="deleteCurrentPrompt()" class="flex-1 py-2 px-2 bg-red-500 text-white rounded-full shadow hover:bg-red-600">EXCLUIR</button></div><div id="prompt-novo-view"><div class="space-y-3 text-sm"><div class="my-2 h-32 bg-white/30 rounded-lg flex items-center justify-center overflow-hidden border-2 border-dashed border-white/40"><img id="prompt-image-preview" src="" class="hidden h-full w-full object-contain"><span id="image-placeholder" class="text-white/80">Visualização da Imagem</span></div><!-- NOVO: Campo de URL da imagem --><input type="text" id="prompt-image-url" oninput="updateImagePreviewFromURL()" placeholder="Cole a URL da imagem aqui" class="w-full p-2 rounded-lg"><input type="text" id="prompt-id" placeholder="ID (automático)" class="w-full p-2 rounded-lg" disabled><input type="text" id="prompt-marca-ia" placeholder="Marca IA (ex: Gemini)" class="w-full p-2 rounded-lg"><input type="text" id="prompt-category" placeholder="Categoria (ex: Divertido)" class="w-full p-2 rounded-lg"><input type="text" id="prompt-description" placeholder="Descrição" class="w-full p-2 rounded-lg"><input type="text" id="prompt-link" placeholder="Link da IA" class="w-full p-2 rounded-lg"><textarea id="prompt-text" placeholder="Texto do prompt..." class="w-full p-2 rounded-lg h-24 resize-none"></textarea><button id="save-prompt-button" class="w-full p-2 rounded-lg bg-green-500 text-white font-bold hover:bg-green-600" onclick="saveCurrentPrompt()">SALVAR</button></div></div><div id="prompt-pesquisar-view" class="hidden"><input type="text" id="prompt-search-input" onkeyup="renderPrompts()" placeholder="Pesquisar..." class="w-full p-2 rounded-lg"><div id="prompt-list" class="history-box bg-white/80 p-2 rounded-lg h-[25.5rem] overflow-y-auto text-sm space-y-2"></div></div></div>
        </main>
        <footer class="text-center mt-6 text-white/70 text-sm">By: A.Yoshi</footer>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <!-- REMOVIDO: O SDK do Storage não é mais necessário -->
    <!-- <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script> -->
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyAg37Z0ahi-a_jNt_X89UUY1oj7RiNuMFs",
          authDomain: "yoshi-prompts-app.firebaseapp.com",
          projectId: "yoshi-prompts-app",
          storageBucket: "yoshi-prompts-app.appspot.com",
          messagingSenderId: "509816669209",
          appId: "1:509816669209:web:695a6c4bd2d18014371688"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        // REMOVIDO: a inicialização do Storage não é mais necessária
        // const storage = firebase.storage();
        let allUsers = [], allPrompts = [], allLogs = [], onConfirmAction = () => {};
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('admin-name').textContent = sessionStorage.getItem('username') || 'Admin';
            document.getElementById('confirm-yes').addEventListener('click', () => { onConfirmAction(); closeConfirm(); });
            document.getElementById('confirm-no').addEventListener('click', closeConfirm);
            // REMOVIDO: o listener do input de arquivo não é mais necessário
            // document.getElementById('prompt-image-input').addEventListener('change', handleImagePreview);
            document.getElementById('user-vencimento').addEventListener('change', updateUserVencimentoLabel);
            await loadAllData();
            showPage('adc-prompts');
        });
        async function loadAllData() {
            try {
                const [usersSnap, promptsSnap, logsSnap] = await Promise.all([
                    db.collection('users').get(),
                    db.collection('prompts').orderBy('createdAt', 'desc').get(),
                    db.collection('activityLog').orderBy('timestamp', 'desc').get()
                ]);
                allUsers = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allPrompts = promptsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allLogs = logsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            } catch (error) { 
                console.error("Erro ao carregar dados:", error); 
                if (error.code === 'permission-denied') { showNotification("Erro de Permissão: Verifique as Regras de Segurança do Firestore."); } 
                else { showNotification("Falha ao carregar dados. Verifique a conexão."); }
            }
        }
        function showPage(pageId) {
            ['monitorar-page', 'cadastrar-page', 'adc-prompts-page'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById(pageId + '-page').classList.remove('hidden');
            document.querySelectorAll('.btn-main').forEach(btn => btn.classList.toggle('active', btn.dataset.page === pageId));
            if (pageId === 'monitorar') renderGlobalActivityLog();
            if (pageId === 'adc-prompts') { newPrompt(); renderPrompts(); }
            if (pageId === 'cadastrar') { newUser(); renderUsers(); }
        }
        // --- FUNÇÕES DE PROMPTS (MODIFICADAS) ---
        function updateImagePreviewFromURL() {
            const imageUrl = document.getElementById('prompt-image-url').value.trim();
            const preview = document.getElementById('prompt-image-preview');
            const placeholder = document.getElementById('image-placeholder');
            if (imageUrl) {
                preview.src = imageUrl;
                preview.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                preview.src = '';
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }
        async function saveCurrentPrompt() {
            const saveButton = document.getElementById('save-prompt-button');
            saveButton.disabled = true;
            saveButton.textContent = 'SALVANDO...';
            const promptId = document.getElementById('prompt-id').value;
            const imageUrl = document.getElementById('prompt-image-url').value.trim();
            
            const promptData = { 
                marca_ia: document.getElementById('prompt-marca-ia').value.trim(), 
                category: document.getElementById('prompt-category').value.trim(), 
                description: document.getElementById('prompt-description').value.trim(), 
                link: document.getElementById('prompt-link').value.trim(), 
                text: document.getElementById('prompt-text').value.trim(), 
                image: imageUrl || '',
                createdAt: firebase.firestore.FieldValue.serverTimestamp() 
            };
            if (!promptData.description || !promptData.category || !promptData.marca_ia) { 
                showNotification("Preencha Descrição, Categoria e Marca IA."); 
                saveButton.disabled = false;
                saveButton.textContent = 'SALVAR';
                return; 
            }
            try {
                if (promptId) { 
                    delete promptData.createdAt; 
                    await db.collection('prompts').doc(promptId).set(promptData, { merge: true }); 
                } else { 
                    const docRef = await db.collection('prompts').add(promptData); 
                    document.getElementById('prompt-id').value = docRef.id; 
                }
                showNotification('Prompt salvo!');
                await loadAllData(); 
                renderPrompts();
                newPrompt();
            } catch (error) { 
                console.error("Erro ao salvar prompt:", error); 
                showNotification("Erro ao salvar prompt."); 
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'SALVAR';
            }
        }
        function clearPromptForm() { 
            ['prompt-id', 'prompt-marca-ia', 'prompt-category', 'prompt-description', 'prompt-link', 'prompt-text', 'prompt-image-url'].forEach(id => document.getElementById(id).value = ''); 
            const preview = document.getElementById('prompt-image-preview');
            preview.src = ''; 
            preview.classList.add('hidden'); 
            document.getElementById('image-placeholder').classList.remove('hidden'); 
        }
        function populatePromptForm(prompt) {
            clearPromptForm();
            document.getElementById('prompt-id').value = prompt.id;
            document.getElementById('prompt-marca-ia').value = prompt.marca_ia;
            document.getElementById('prompt-category').value = prompt.category;
            document.getElementById('prompt-description').value = prompt.description;
            document.getElementById('prompt-link').value = prompt.link || '';
            document.getElementById('prompt-text').value = prompt.text;
            if (prompt.image) {
                document.getElementById('prompt-image-url').value = prompt.image;
                updateImagePreviewFromURL();
            }
        }
        async function deleteCurrentPrompt() {
            const promptId = document.getElementById('prompt-id').value;
            if (!promptId) { showNotification("Nenhum prompt selecionado."); return; }
            const prompt = allPrompts.find(p => p.id === promptId);
            showConfirm(`Excluir o prompt "${prompt.description}"?`, async () => {
                try {
                    await db.collection('prompts').doc(promptId).delete();
                    showNotification(`Prompt excluído!`);
                    await loadAllData(); 
                    newPrompt(); 
                    renderPrompts();
                } catch (error) { console.error("Erro ao excluir prompt:", error); showNotification("Erro ao excluir."); }
            });
        }
        // --- O RESTANTE DAS FUNÇÕES (sem alterações) ---
        function renderGlobalActivityLog() {
            const container = document.getElementById('global-history-log');
            container.innerHTML = allLogs.length === 0 ? '<p class="text-center p-4">Nenhuma atividade.</p>' : allLogs.map(log => {
                const date = log.timestamp ? log.timestamp.toDate().toLocaleString('pt-BR') : 'Data inválida';
                return `<div><p><strong>${log.userName || 'Usuário'}</strong> - ${date}: ${log.action}</p><hr class="border-white/50 my-1"></div>`;
            }).join('');
        }
        function showUserView(viewName) {
            document.getElementById('user-form-view').classList.toggle('hidden', viewName === 'pesquisar');
            document.getElementById('user-pesquisar-view').classList.toggle('hidden', viewName !== 'pesquisar');
            document.querySelectorAll('#cadastrar-page .btn-sub').forEach(btn => btn.classList.toggle('active', btn.dataset.userview === viewName));
        }
        function newUser() { clearUserForm(); showUserView('form'); }
        function editUser(userId) { const user = allUsers.find(u => u.id === userId); if (user) { populateUserForm(user); showUserView('form'); } }
        async function saveCurrentUser() {
            const userId = document.getElementById('user-id').value;
            const userData = { name: document.getElementById('user-name').value.trim(), password: document.getElementById('user-password').value.trim(), login: document.getElementById('user-login').value.trim(), vencimento: document.getElementById('user-vencimento').value };
            if (!userData.name || !userData.password || !userData.login || !userData.vencimento) { showNotification("Preencha todos os campos."); return; }
            try {
                if (userId) { await db.collection('users').doc(userId).set(userData, { merge: true }); } 
                else { const docRef = await db.collection('users').add(userData); document.getElementById('user-id').value = docRef.id; }
                showNotification('Usuário salvo!');
                await loadAllData(); renderUsers();
            } catch (error) { console.error("Erro ao salvar usuário:", error); showNotification("Erro ao salvar."); }
        }
        function renderUsers() {
            const searchTerm = document.getElementById('user-search-input').value.toLowerCase();
            const container = document.getElementById('user-list');
            const filtered = allUsers.filter(u => u.name.toLowerCase().includes(searchTerm) || u.login.toLowerCase().includes(searchTerm));
            container.innerHTML = filtered.length === 0 ? '<p class="text-center p-4">Nenhum usuário.</p>' : filtered.map(user => `<div class="p-2 bg-white/50 rounded-md cursor-pointer hover:bg-white/80" onclick="editUser('${user.id}')"><p class="font-semibold">${user.name}</p><p class="text-xs text-cyan-800">${user.login}</p></div>`).join('');
        }
        async function deleteCurrentUser() {
            const userId = document.getElementById('user-id').value;
            if (!userId) { showNotification("Nenhum usuário selecionado."); return; }
            showConfirm(`Excluir "${document.getElementById('user-name').value}"?`, async () => {
                try {
                    await db.collection('users').doc(userId).delete();
                    showNotification(`Usuário excluído!`);
                    await loadAllData(); newUser(); renderUsers();
                } catch (error) { console.error("Erro ao excluir:", error); showNotification("Erro ao excluir."); }
            });
        }
        function updateUserVencimentoLabel() { const dateValue = document.getElementById('user-vencimento').value; if(dateValue) { const [y,m,d] = dateValue.split('-'); document.getElementById('user-vencimento-label').textContent = `Vence em ${d}/${m}/${y}`; } }
        function newPrompt() { clearPromptForm(); showPromptView('novo'); }
        function showPromptView(viewName) { document.getElementById('prompt-novo-view').classList.toggle('hidden', viewName !== 'novo'); document.getElementById('prompt-pesquisar-view').classList.toggle('hidden', viewName === 'novo'); }
        function editPrompt(promptId) { const prompt = allPrompts.find(p => p.id === promptId); if (prompt) { populatePromptForm(prompt); showPromptView('novo'); } }
        function renderPrompts() {
            const searchTerm = document.getElementById('prompt-search-input').value.toLowerCase();
            const container = document.getElementById('prompt-list');
            const filtered = allPrompts.filter(p => p.description.toLowerCase().includes(searchTerm) || p.category.toLowerCase().includes(searchTerm));
            container.innerHTML = filtered.length === 0 ? '<p class="text-center p-4">Nenhum prompt.</p>' : filtered.map(p => `<div class="p-2 bg-white/50 rounded-md cursor-pointer hover:bg-white/80" onclick="editPrompt('${p.id}')"><p class="font-semibold">${p.description}</p><p class="text-xs text-cyan-800 font-bold">${p.category.toUpperCase()}</p></div>`).join('');
        }
        function showNotification(message) { const el = document.getElementById('notification-modal'); el.querySelector('p').textContent = message; el.classList.remove('hidden'); setTimeout(() => el.classList.add('hidden'), 3500); }
        function showConfirm(message, callback) { const el = document.getElementById('confirm-modal'); el.querySelector('p').textContent = message; onConfirmAction = callback || (() => {}); el.classList.remove('hidden'); }
        function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden'); }
        function saveAsPDF() {
            const { jsPDF } = window.jspdf;
            const logContainer = document.getElementById('global-history-log');
            showNotification("Gerando PDF...");
            html2canvas(logContainer, { scale: 2 }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgWidth = pdfWidth - 20;
                const imgHeight = canvas.height * imgWidth / canvas.width;
                pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save(`historico_yoshi_prompts_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
            }).catch(err => { console.error("Erro ao gerar PDF:", err); showNotification("Falha ao gerar o PDF."); });
        }
        function backupData() {
            showNotification("Preparando backup...");
            const dataToBackup = { users: allUsers, prompts: allPrompts, activityLog: allLogs, exportedAt: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(dataToBackup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `backup_yoshi_prompts_${new Date().toISOString().split('T')[0]}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showNotification('Backup baixado com sucesso!');
        }
        function triggerRestore() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = readerEvent => {
                    try {
                        const content = JSON.parse(readerEvent.target.result);
                        if (content.users && content.prompts && content.activityLog) {
                            showConfirm("Restaurar este backup substituirá os dados atuais. Continuar?", () => restoreData(content));
                        } else { showNotification("Arquivo de backup inválido."); }
                    } catch (error) { showNotification("Erro ao ler o arquivo de backup."); console.error("Erro no restore:", error); }
                };
                reader.readAsText(file, 'UTF-8');
            };
            input.click();
        }
        async function restoreData(data) {
            showNotification("Restaurando... Não feche a página.");
            try {
                const batch = db.batch();
                data.users.forEach(user => { const docRef = user.id ? db.collection('users').doc(user.id) : db.collection('users').doc(); batch.set(docRef, user); });
                data.prompts.forEach(prompt => { const docRef = prompt.id ? db.collection('prompts').doc(prompt.id) : db.collection('prompts').doc(); batch.set(docRef, prompt); });
                data.activityLog.forEach(log => { const docRef = log.id ? db.collection('activityLog').doc(log.id) : db.collection('activityLog').doc(); batch.set(docRef, log); });
                await batch.commit();
                showNotification('Backup restaurado! Recarregando...');
                await loadAllData();
                showPage('monitorar');
            } catch (error) { console.error("Erro ao restaurar dados:", error); showNotification("Falha na restauração."); }
        }
    </script>
</body>
</html>

